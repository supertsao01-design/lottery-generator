<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>台灣彩券 — 近五年熱號號碼產生器</title>
<style>
  body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans CJK TC", "微軟正黑體"; padding: 20px; background:#f7fafc; color:#0f172a; }
  .card { background: white; padding:18px; border-radius:12px; box-shadow: 0 6px 18px rgba(2,6,23,0.08); max-width:720px; margin:auto; }
  h1 { margin:0 0 10px 0; font-size:20px; }
  select, button { font-size:16px; padding:8px 12px; border-radius:8px; border:1px solid #d1d5db; }
  label { display:block; margin:10px 0 6px; }
  .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .result { margin-top:16px; display:flex; gap:8px; flex-wrap:wrap; }
  .ball { width:56px; height:56px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:18px; background:#e6eef8; color:#04263b; box-shadow:0 3px 8px rgba(2,6,23,0.06); }
  .special { background:#fde68a; }
  .small { font-size:13px; color:#475569; margin-top:8px; }
  .muted { color:#64748b; font-size:13px; }
  .footer { margin-top:18px; font-size:13px; color:#475569; }
</style>
</head>
<body>
<div class="card">
  <h1>台灣彩券 — 近五年熱號號碼產生器</h1>

  <label for="game">選擇彩種</label>
  <div class="row">
    <select id="game">
      <option value="lotto">大樂透 (1-49 選6)</option>
      <option value="power">威力彩 (第1區1-38選6，第2區1-8選1)</option>
      <option value="539">今彩539 (1-39 選5)</option>
    </select>

    <label style="margin-left:8px;"><input type="checkbox" id="useHot" checked /> 依近 5 年熱號加權</label>
    <button id="genBtn">產生一組號碼</button>
    <button id="reloadStats" title="嘗試從網路拉取近五年開獎資料">重新抓取近五年資料</button>
  </div>

  <div class="small muted">說明：程式會嘗試依「近五年開獎頻率」給熱門號較高機率選中；若網路抓取失敗，會退回到公平隨機或內建預設權重（仍可使用）。</div>

  <div id="output" class="result" aria-live="polite" style="margin-top:16px;"></div>

  <div class="footer">
    資料來源（參考）：台灣彩券官網、公開開獎記錄站與統計站點。<br>
    程式會嘗試從公開歷史頁面抓取資料（若你希望我把「已計算好的近五年頻率」直接嵌入此檔案，我可以替你處理並回傳一版已內嵌頻率的 HTML）。
  </div>
</div>

<script>
/*
  主要邏輯：
  - 嘗試抓取近五年（今天往回算 5 年）各期開獎號碼（若同源網站允許）。
  - 計算每個號碼的出現次數 -> 轉成權重（頻率）。
  - 產生號碼時用「權重抽樣（不放回）」來挑號（確保不重複）。
  - 若抓取失敗：採用簡單的 fallback 權重（近期常見區間偏好）或純隨機。
*/

const GAME_CONFIG = {
  lotto: { name:'大樂透', min:1, max:49, pick:6, special:false },
  power: { name:'威力彩', min1:1, max1:38, pick1:6, min2:1, max2:8, pick2:1, special:true },
  '539': { name:'今彩539', min:1, max:39, pick:5, special:false }
};

let freqCache = {
  // structure:
  // lotto: {counts: [...], totalDraws: n, lastUpdated: dateString}
  // power: {counts1: [...], counts2: [...], ...}
};

// Helper: create arr of numbers 1..n
function range(n, start=1){ return Array.from({length:n}, (_,i)=>i+start); }

// Weighted sample without replacement
function weightedSampleNoReplace(weightsMap, k) {
  // weightsMap: {num: weight, ...}
  const picked = [];
  const items = Object.keys(weightsMap).map(n => ({n:parseInt(n), w:weightsMap[n]}));
  for (let i=0;i<k;i++){
    const total = items.reduce((s,it)=>s+it.w,0);
    if (total <= 0) {
      // fallback to uniform among remaining
      const remain = items.filter(it=>it.w>=0);
      const idx = Math.floor(Math.random()*remain.length);
      picked.push(remain[idx].n);
      items.splice(items.indexOf(remain[idx]),1);
      continue;
    }
    let r = Math.random()*total;
    let idx = 0;
    while (r > items[idx].w) { r -= items[idx].w; idx++; if(idx>=items.length) break; }
    picked.push(items[idx].n);
    items.splice(idx,1);
  }
  return picked.sort((a,b)=>a-b);
}

async function tryFetchStats() {
  // This function attempts to fetch historical pages and compute frequencies.
  // NOTE: Many public pages have CORS restrictions, so in-browser fetch may fail.
  // We attempt to fetch from a few known pages; if fetch fails, we keep freqCache empty.
  const now = new Date();
  const fiveYearsAgo = new Date(); fiveYearsAgo.setFullYear(now.getFullYear()-5);
  // Example attempt URLs (public history pages). These may be blocked by CORS.
  const attempts = [
    { game:'lotto', url:'https://www.taiwanlottery.com/lotto/history/history_result/' },
    { game:'lotto', url:'https://www.pilio.idv.tw/ltobig/listbigBIG.asp' },
    { game:'power', url:'https://www.pilio.idv.tw/lto/listBIG.asp' },
    { game:'539', url:'https://www.pilio.idv.tw/lto539/list539APP.asp' },
    { game:'539', url:'https://www.pilio.idv.tw/lto539/list.asp' }
  ];

  // We'll try the pilio pages first (they present many draws in HTML).
  // Because of CORS we try-catch; if successful we'll parse numbers via regex.
  let success = false;
  for (const a of attempts) {
    try {
      const resp = await fetch(a.url, {mode:'cors'});
      const text = await resp.text();
      // quick parse: find lines like "開獎日期:2025/09/12 02, 03, ..." or patterns of numbers.
      const matches = text.matchAll(/開獎日期[:：]\s*\d{4}\/\d{2}\/\d{2}[\s\S]*?(\d{2}(?:,\s*\d{2}){1,6})/g);
      // fallback generic number-lines: sequences of numbers with commas
      const genericMatches = text.matchAll(/(\b(?:0?\d|[1-4]\d|49)\b(?:\s*,\s*\b(?:0?\d|[1-4]\d|49)\b){1,6})/g);
      // We'll be conservative: only parse if we find many lines.
      const found = [];
      for (const m of matches) {
        if (m[1]) {
          found.push(m[1].replace(/\s/g,''));
        }
      }
      for (const m of genericMatches) {
        if (m[1]) found.push(m[1].replace(/\s/g,''));
      }
      if (found.length < 30) { /* not enough draws found - skip */ continue; }

      // Count frequencies by splitting commas
      if (a.game === 'lotto') {
        const counts = Array(50).fill(0); // 0 unused
        for (const line of found) {
          const nums = line.split(',').map(s=>parseInt(s,10)).filter(n=>n>=1 && n<=49);
          nums.forEach(n=>counts[n]++);
        }
        freqCache.lotto = { counts, totalDraws: found.length, lastUpdated: new Date().toISOString() };
        success = true;
      } else if (a.game === '539') {
        const counts = Array(40).fill(0);
        for (const line of found) {
          const nums = line.split(',').map(s=>parseInt(s,10)).filter(n=>n>=1 && n<=39);
          nums.forEach(n=>counts[n]++);
        }
        freqCache['539'] = { counts, totalDraws: found.length, lastUpdated: new Date().toISOString() };
        success = true;
      } else if (a.game === 'power') {
        // For 威力彩 we need to parse first-zone (1-38) and second-zone (1-8)
        const counts1 = Array(39).fill(0);
        const counts2 = Array(9).fill(0);
        // heuristic: many lines contain "第一區" or "第二區" - but simpler: extract sequences of 6 and sequences of single small number
        const lineMatches = text.matchAll(/\b(?:\d{2}|\d{1})(?:\s*,\s*(?:\d{2}|\d{1})){5}\b/g);
        for (const m of lineMatches) {
          const nums = m[0].split(',').map(s=>parseInt(s,10));
          if (nums.length===6 && nums.every(n=>n>=1 && n<=38)) {
            nums.forEach(n=>counts1[n]++);
          }
        }
        // second-zone search: small numbers 1..8 appearing near label "第二區" if possible
        const secondMatches = text.matchAll(/第二區[:：\s]*([0-9]{1,2})/g);
        for (const m of secondMatches) {
          const n = parseInt(m[1],10);
          if (n>=1 && n<=8) counts2[n]++;
        }
        freqCache.power = { counts1, counts2, totalDraws: Math.max(...counts1), lastUpdated: new Date().toISOString() };
        success = true;
      }

      if (success) break;
    } catch (e) {
      // fetch may throw due to CORS or network; continue to next attempt
      console.warn('fetch attempt failed for', a.url, e);
      continue;
    }
  }

  return success;
}

// fallback simple weight generator (if no real stats available)
// For demonstration we'll give slightly higher weight to "middle-range" numbers
function buildFallbackWeights(min, max) {
  const weights = {};
  for (let n=min;n<=max;n++){
    // bias: mid numbers slightly heavier (just a heuristic; not real 5-year stats)
    const mid = (min+max)/2;
    const dist = Math.abs(n-mid);
    const w = 1 + Math.max(0, ( (max-min)/4 - dist ) / ((max-min)/4)); // values roughly 1..2
    weights[n] = w;
  }
  return weights;
}

function generateForGame(gameKey, useHot=true) {
  if (gameKey === 'lotto') {
    const cfg = GAME_CONFIG.lotto;
    let weights = {};
    if (useHot && freqCache.lotto && freqCache.lotto.counts) {
      const counts = freqCache.lotto.counts;
      const total = counts.reduce((s,c)=>s+c,0) || 1;
      for (let n=1;n<=49;n++) weights[n] = Math.max(1, counts[n] / total * 50); // normalize scale
    } else {
      weights = buildFallbackWeights(1,49);
    }
    const pick = weightedSampleNoReplace(weights, cfg.pick);
    return { title:'大樂透', numbers: pick };
  } else if (gameKey === 'power') {
    const cfg = GAME_CONFIG.power;
    let w1 = {}, w2 = {};
    if (useHot && freqCache.power && freqCache.power.counts1) {
      const counts1 = freqCache.power.counts1;
      const total1 = counts1.reduce((s,c)=>s+c,0) || 1;
      for (let n=1;n<=38;n++) w1[n] = Math.max(1, counts1[n]/total1*30);
      const counts2 = freqCache.power.counts2 || Array(9).fill(0);
      const total2 = counts2.reduce((s,c)=>s+c,0) || 1;
      for (let n=1;n<=8;n++) w2[n] = Math.max(1, counts2[n]/total2*10);
    } else {
      w1 = buildFallbackWeights(1,38);
      w2 = buildFallbackWeights(1,8);
    }
    const pick1 = weightedSampleNoReplace(w1, cfg.pick1);
    const pick2 = weightedSampleNoReplace(w2, cfg.pick2);
    return { title:'威力彩', numbers: pick1, special: pick2[0] };
  } else if (gameKey === '539') {
    const cfg = GAME_CONFIG['539'];
    let weights = {};
    if (useHot && freqCache['539'] && freqCache['539'].counts) {
      const counts = freqCache['539'].counts;
      const total = counts.reduce((s,c)=>s+c,0) || 1;
      for (let n=1;n<=39;n++) weights[n] = Math.max(1, counts[n] / total * 40);
    } else {
      weights = buildFallbackWeights(1,39);
    }
    const pick = weightedSampleNoReplace(weights, cfg.pick);
    return { title:'今彩539', numbers: pick };
  }
  return null;
}

function renderResult(obj) {
  const out = document.getElementById('output');
  out.innerHTML = '';
  if (!obj) return;
  if (obj.title === '威力彩') {
    obj.numbers.forEach(n=>{
      const d = document.createElement('div');
      d.className = 'ball';
      d.textContent = n.toString().padStart(2,'0');
      out.appendChild(d);
    });
    const sp = document.createElement('div');
    sp.className = 'ball special';
    sp.textContent = obj.special.toString().padStart(2,'0');
    out.appendChild(sp);

    const note = document.createElement('div');
    note.className = 'muted';
    note.style.width='100%';
    note.textContent = '（第1區 6 顆，第2區 1 顆）';
    out.appendChild(note);
  } else {
    obj.numbers.forEach(n=>{
      const d = document.createElement('div');
      d.className = 'ball';
      d.textContent = n.toString().padStart(2,'0');
      out.appendChild(d);
    });
  }
}

document.getElementById('genBtn').addEventListener('click', ()=>{
  const g = document.getElementById('game').value;
  const useHot = document.getElementById('useHot').checked;
  const res = generateForGame(g, useHot);
  renderResult(res);
});

document.getElementById('reloadStats').addEventListener('click', async ()=>{
  document.getElementById('reloadStats').textContent = '抓取中...';
  const ok = await tryFetchStats();
  document.getElementById('reloadStats').textContent = '重新抓取近五年資料';
  if (ok) {
    alert('成功抓取公開歷史頁面的資料（若網站允許 CORS 的話）。系統會以抓到的頻率做加權。');
  } else {
    alert('無法從公開網站取得資料（可能因為 CORS 或網站限制）。系統會使用內建 fallback 權重或純隨機。若你要我把已計算好的近五年頻率直接嵌入此檔案，我可以替你處理並回傳新的 HTML。');
  }
});

// try to fetch stats on load (best-effort)
tryFetchStats().then(ok=>{
  console.log('initial stats fetch', ok);
});

</script>
</body>
</html>
